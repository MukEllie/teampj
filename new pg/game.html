<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게임 - Game Portal</title>
    <link rel="stylesheet" href="styles.css">
    <link rel = "stylesheet" href = "css/common.css">
    <link rel = "stylesheet" href = "css/game.css">
    <script src="common-auth.js"></script>
</head>
<body>
    <header>
        <nav id = "nav_1">
            <div class = "profile" id = "auth-buttons">
                <a class = "nav_1_text" href = "/login" id = "loginBtn">로그인</a>
                <a class = "nav_1_text" href = "/signup" id = "signupBtn">회원가입</a>
            </div>
        </nav>
        <div class = "line"></div>
        <nav id = "nav_2">
            <a class = "nav_2_text" href = "game.html">게임 플레이</a>
            <a class = "nav_2_text" href = "game-info.html">게임 정보</a>
            <a class = "nav_2_text" href = "news.html">공지사항</a>
            <a href = "index.html">
                <img id = "logo" src = "image/logo/Logo_2_1.png">
            </a>
            <a class = "nav_2_text" href = "community.html">커뮤니티</a>
            <a class = "nav_2_text" href = "media.html">미디어</a>
            <a class = "nav_2_text" href = "customer-service.html">고객센터</a>
        </nav>
    </header>

    <!-- 게임 컨테이너 -->
    <div class="game-container">
        <!-- 로딩 화면 -->
        <div class="game-loading" id="gameLoading">
            <div class="loading-spinner"></div>
            <div class="loading-text">게임 로딩 중...</div>
            <div class="loading-subtitle">잠시만 기다려주세요</div>
        </div>

        <!-- React 게임 iframe -->
        <iframe 
            id="gameFrame" 
            class="game-frame" 
            src="http://localhost:3000"
            title="React Game">
        </iframe>
    </div>

    <script>
        // 모바일 메뉴 토글
        const mobileToggle = document.getElementById('mobileToggle');
        const navMenu = document.getElementById('navMenu');

        if (mobileToggle && navMenu) {
            mobileToggle.addEventListener('click', function() {
                this.classList.toggle('active');
                navMenu.classList.toggle('active');
            });
        }

        // 스크롤 효과
        window.addEventListener('scroll', function() {
            const header = document.querySelector('.header');
            if (header) {
                if (window.scrollY > 100) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            }
        });

        // 게임 로딩 관리
        const gameFrame = document.getElementById('gameFrame');
        const gameLoading = document.getElementById('gameLoading');
        
        // 3001(localStorage) → 3000(iframe)로 userId 전달: iframe src에 ?userId= 붙이기
        (function attachUserIdToIframe() {
            try {
                // 로그인 시 저장한 정보에서 userId 추출 (여러 후보키 지원)
                const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const fallback = localStorage.getItem('userId');
                const uid = user.userId || user.username || user.id || fallback || '';
                if (!uid || !gameFrame) return;
                const u = new URL(gameFrame.src, window.location.href);
                u.searchParams.set('userId', uid);
                // src가 이미 ?userId 갖고 있어도 덮어씀(최신값 보장)
                gameFrame.src = u.toString();
            } catch (e) {
                console.warn('게임 iframe 링크 구성 실패:', e);
            }
        })();

        function showLoading() {
            gameLoading.style.display = 'flex';
            gameFrame.style.display = 'none';
        }

        function showGame() {
            gameLoading.style.display = 'none';
            gameFrame.style.display = 'block';
        }

        // iframe 로드 완료 이벤트
        gameFrame.addEventListener('load', function() {
            setTimeout(() => {
                showGame();
            }, 1000); // 1초 딜레이로 로딩 화면 유지
        });

        // 페이지 로드시 초기화
        window.addEventListener('load', function() {
            showLoading();
        });

        // 네비게이션 링크 활성화 상태 관리
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                // 현재 페이지 링크는 활성 상태 유지
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                
                const href = this.getAttribute('href');
                if (href && href.endsWith('.html')) {
                    console.log('페이지 이동:', href);
                }
            });
        });

        // 현재 페이지의 네비게이션 링크 활성화
        const currentPage = 'game.html';
        document.querySelectorAll('.nav-link').forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });
    </script>
</body>
</html>